name: Windows RDP using Tailscale

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up user and enable RDP
        shell: powershell
        run: |
          $password = "GantiPasswordIni123"
          echo "Setting password for Administrator account..."
          net user Administrator $password /active:yes
          
          echo "Enabling RDP connections in the registry..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          
          echo "Enabling Remote Desktop firewall rule..."
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          echo "RDP setup complete."

      # --- BAGIAN YANG DIPERBARUI ---
      - name: Install and Run Tailscale (Metode Winget)
        run: |
          echo "Menginstal Tailscale menggunakan winget (dengan path lengkap)..."
          # Menentukan path lengkap ke winget.exe karena terkadang tidak ada di sistem PATH
          $wingetPath = "$env:LOCALAPPDATA\Microsoft\WindowsApps\winget.exe"
          
          # Menjalankan perintah winget menggunakan path lengkap
          & $wingetPath install --id Tailscale.Tailscale -e --accept-source-agreements --accept-package-agreements
          
          echo "Menjalankan Tailscale dan menghubungkan ke jaringan..."
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-windows
      # ---------------------------

      - name: Show Tailscale IP Address
        run: |
          echo "Menunggu alamat IP Tailscale..."
          Start-Sleep -Seconds 10
          echo "Alamat IP Tailscale untuk mesin ini adalah:"
          & "C:\Program Files\Tailscale\tailscale.exe" ip -4

      - name: Keep Runner Alive
        run: |
          echo "RDP siap. Alur kerja akan tetap berjalan. Gunakan alamat IP Tailscale dari langkah sebelumnya untuk terhubung."
          Start-Sleep -Seconds 21000
